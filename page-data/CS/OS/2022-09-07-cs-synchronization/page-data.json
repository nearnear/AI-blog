{"componentChunkName":"component---src-templates-blog-post-js","path":"/CS/OS/2022-09-07-cs-synchronization/","result":{"data":{"allMarkdownRemark":{"totalCount":58},"markdownRemark":{"id":"49dc2c46-9002-574a-8b7a-88f641c9e982","html":"<h2>1. 동기화</h2>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.25em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mtext>Synchronization of Process or Thread</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mrow><mo fence=\"true\">{</mo><mtable rowspacing=\"0.36em\" columnalign=\"left left\" columnspacing=\"1em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mtext>1. Control execution order of processes or threads</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"false\"><mtext>2. Mutual exclusion on certain resources</mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\begin{aligned}\n&#x26; \\text{Synchronization of Process or Thread} \\\\\n&#x26; \\begin{cases}\n    \\text{1. Control execution order of processes or threads} \\\\\n    \\text{2. Mutual exclusion on certain resources}\n\\end{cases}\n\\end{aligned}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:4.8em;vertical-align:-2.15em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.65em;\"><span style=\"top:-5.56em;\"><span class=\"pstrut\" style=\"height:3.75em;\"></span><span class=\"mord\"></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.75em;\"></span><span class=\"mord\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.15em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.65em;\"><span style=\"top:-5.56em;\"><span class=\"pstrut\" style=\"height:3.75em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mord text\"><span class=\"mord\">Synchronization of Process or Thread</span></span></span></span><span style=\"top:-3.15em;\"><span class=\"pstrut\" style=\"height:3.75em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size4\">{</span></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.69em;\"><span style=\"top:-3.69em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">1. Control execution order of processes or threads</span></span></span></span><span style=\"top:-2.25em;\"><span class=\"pstrut\" style=\"height:3.008em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">2. Mutual exclusion on certain resources</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.19em;\"><span></span></span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.15em;\"><span></span></span></span></span></span></span></span></span></span></span></span></div>\n<br>\n<p>프로세스 동기화 또는 스레드 동기화는 프로세스 또는 스레드의 실행 순서를 제어하고 특정 자원에 대한 접근을 제한해 자원의 일관성을 보장하는 것을 의미한다.</p>\n<p>프로세스 또는 스레드 동기화는 두가지 방법에서 접근할 수 있다:</p>\n<ol>\n<li>실행 순서 제어 : 프로세스나 스레드를 실행하기 위한 순서를 지키는 것을 의미한다.\n<ul>\n<li>ex) 파일 읽기 작업을 수행하는 Reader가 파일 쓰기 작업을 수행하는 Writer 보다 먼저 실행되면, 읽어들일 파일이 없어 예외가 발생한다.</li>\n</ul>\n</li>\n<li>상호 배제 (Mutual Exclusion) : 특정 자원에 접근하는 프로세스나 스레드를 제한하는 것을 의미한다.</li>\n</ol>\n<ul>\n<li>ex) 읽기 작업을 수행한 후 값을 변경해 쓰기 작업을 수행하는 Add는 값을 읽어 1을 더하고, Mult는 값을 읽어 2를 곱한다. 초기값은 0이다.\n<ul>\n<li>Add와 Mult를 순차적으로 실행해도 Add가 값을 읽어들인 후 쓰기 작업을 수행하기 전에 Mult가 값을 읽어들이면 Add와 Mult는 모두 초기 값 0을 읽어들여 각각 1과 5를 쓴다. 최종값은 1 또는 5가 된다.</li>\n<li>반면 Add가 쓰기 작업을 끝낸 후 Mult를 실행하면 Mult는 Add의 결과값 1을 읽어들여 최종값은 6이 된다.</li>\n</ul>\n</li>\n</ul>\n<br>\n<h3>1.1 생산자-소비자 문제</h3>\n<p>상호 배제의 중요성은 생산자-소비자 문제(Producer-Consumer Problem)에서 부각된다.</p>\n<p>생산자와 소비자가 변수 total를 공유할 때, 생산자는 값을 1 늘리고 소비자는는 값을 1 줄인다고 하자.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"c++\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Producer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk6\">produce</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\">(</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100000</span><span class=\"mtk1\">; i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total</span><span class=\"mtk7\">++</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Consumer</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk6\">consume</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\">(</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">100000</span><span class=\"mtk1\">; i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        total</span><span class=\"mtk7\">--</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>다음 코드처럼 생산자와 소비자를 (동기화 없이) 각각 하나의 스레드로 실행한 결과를 예측해보자.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"cpp\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// from https://github.com/kangtegong/self-learning-cs/blob/main/producer_consumer/producer_consumer.md</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;iostream&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;thread&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk6\">produce</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk6\">consume</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> total </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> </span><span class=\"mtk6\">main</span><span class=\"mtk1\">(){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::cout </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;초기 합계: &quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\">  total </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::endl;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::thread </span><span class=\"mtk6\">producer</span><span class=\"mtk1\">(produce);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::thread </span><span class=\"mtk6\">consumer</span><span class=\"mtk1\">(consume);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    producer.</span><span class=\"mtk6\">join</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    consumer.</span><span class=\"mtk6\">join</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::cout </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&quot;producer, consumer 스레드 실행 이후 합계: &quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\">  total </span><span class=\"mtk7\">&lt;&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::endl;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 첫번째 실행</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">13819</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 두번째 실행</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">-</span><span class=\"mtk4\">9123</span></span></span></code></pre>\n<p>이때 total 값은 실행할 때마다 바뀌며, 초기값이자 의도한 값인 0과 비슷하지 않은 수를 출력한다.\n이는 두 스레드가 각각 공유하는 자원인 total에 무차별적으로 접근한 결과이므로, 의도한 결과인 0을 도출하기 위해서는 스레드의 동기화가 필요함을 알 수 있다.</p>\n<br>\n<h3>1.2 공유 자원과 임계 구역</h3>\n<p>상호 배제가 필요한 자원을 이해하기 위해 두가지 개념이 필요하다.</p>\n<p><strong>공유 자원(Shared resource)</strong> 은 프로세스나 스레드가 공유하는 자원을 의미한다.</p>\n<ul>\n<li>생산자-소비자 문제에서 공유 자원은 전역 변수 total이다.</li>\n<li>공유 자원은 전역 변수나, 파일, I/O 장치, 보조기억장치 등이다.</li>\n</ul>\n<p>공유 자원에 동시에 접근했을 때 문제가 발생하는 코드 영역을 <strong>임계 구역(Critical section)</strong> 이라고 한다.</p>\n<ul>\n<li>복수의 프로세스 또는 스레드가 임계 구역에 진입하고자 하면 하나의 프로세스 또는 스레드만 실행되고 나머지는 대기해야 한다.</li>\n<li>ex) 프로세스 A가 T1 시점에 임계 구역에 진입했다. 따라서 B가 T2 시점에 임계 구역에 진입을 시도해도 A가 임계 구역을 떠나는 T3 시점까지 대기했다가 진입한다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABO0lEQVR42m2RW4vDIBCF/f9/q8/tU7EUU2gJpInRkJu30dGlDht2l/2eROfMnDmy8pt1Xbuuk1K+3++2bQGglDLPc9/3Usq+gohUzBAx5xxjTCnt+973fSklfYOIWutxHK21prLvOwBQPRuG4XiQUnLOm6a53W5N0zweD1Gx1nrvrbXLshhjqD6EwHKFbABASqmU4pzzlVBBRO99Suk4xxg/tklGLQCA9gkhcM5Pp5MQopTStu35fH69XjlnrfXlcrlerwDASPlnslJq2zYpJSKO4zhNU4zRe6+UWpaFQsk5s67r9sq2bdM0zfNsjHk+n8YYAAgh3O93ikAIwTlf13WreO8Z9aDMnXPk3DmnlBJCDMPgnCN3tC1+85n885PJNnVJKVFIJCA9NTpg5T+MMeRfa62UOu6PdEj8BZ7qPjnBrmlXAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cs critical section\"\n        title=\"\"\n        src=\"/static/afecf8ddb4afd3a5e715be4d523002fb/c1b63/cs-critical_section.png\"\n        srcset=\"/static/afecf8ddb4afd3a5e715be4d523002fb/5a46d/cs-critical_section.png 300w,\n/static/afecf8ddb4afd3a5e715be4d523002fb/0a47e/cs-critical_section.png 600w,\n/static/afecf8ddb4afd3a5e715be4d523002fb/c1b63/cs-critical_section.png 1200w,\n/static/afecf8ddb4afd3a5e715be4d523002fb/a4f81/cs-critical_section.png 1508w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\nimage from <a href=\"https://atelim.com/chapter-6-concurrency-mutual-exclusion-and-synchronization.html\">atelim.com</a></p>\n<p>만약 복수의 프로세스 또는 스레드가 동시에 임계 구역의 코드를 실행하여 문제가 발생하면, 이를 <strong>Race condition</strong> 이라고 부른다. Race condition을 방지하고 자원의 일관성을 지키는 작업이 상호 배제를 위한 동기화인 것이다.</p>\n<p>OS의 상호 배제를 위한 동기화는 다음 세가지 원칙을 준수한다.</p>\n<br>\n<h3>1.3 상호 배제를 위한 동기화의 세가지 원칙</h3>\n<ul>\n<li>Mutual exclusion : 한 프로세스 또는 스레드가 임계 구역에 진입하면 다른 프로세스는 임계 구역에 진입하지 않게 한다.</li>\n<li>Progress : 임계 구역에 진입한 프로세스 또는 스레드가 하나도 없다면 진입하고자하는 프로세스 또는 스레드는 진입할 수 있어야 한다.</li>\n<li>Bounded waiting : 임계 구역에 진입하고자 하는 프로세스 또는 스레드는 진입을 보장받아야 한다.</li>\n</ul>\n<br>\n<br>\n<h2>2. 동기화 방법</h2>\n<h3>2.1. 뮤텍스 락</h3>\n<p>뮤텍스 락(Mutex Lock; MUTual EXclusion Lock)은 상호 배제를 위한 동기화 도구로, 자물쇠를 열고 잠그 듯이 작동한다.</p>\n<p>가장 단순한 형태의 뮤텍스 락은 다음 세가지 항목으로 구현할 수 있다.</p>\n<ul>\n<li>전역 변수 lock : true 이면 잠김, false 이면 열림을 표현한다.</li>\n<li>함수 acquire : 임계 구역에 진입 가능하면 진입해 lock을 true로 바꾸어 다른 스레드가 자원에 접근하는 것을 금지하고, 임계 구역에 진입이 불가능하면 대기한다.</li>\n<li>함수 release : 임계 구역에서 작업을 마친 후 lock을 false로 바꾼다.</li>\n</ul>\n<p>뮤텍스 락으로 상호 배제를 위한 동기화를 구현하는 과정은 다음과 같다.</p>\n<ul>\n<li>전역 변수 lock을 false로 초기화한다.</li>\n<li>임계 구역의 앞에 acquire를, 임계 구역의 뒤에 release를 호출한다.</li>\n</ul>\n<h4>C++ 로 구현하기</h4>\n<pre class=\"grvsc-container abyss\" data-language=\"cpp\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// from https://github.com/kangtegong/self-learning-cs/blob/main/synchronization/syncronization.md#%EC%BD%94%EB%93%9C%EB%A1%9C-%EB%B3%B4%EB%8A%94-%EB%8F%99%EA%B8%B0%ED%99%94</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;stdio.h&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;pthread.h&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#define</span><span class=\"mtk1\"> </span><span class=\"mtk6\">NUM_THREADS</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">pthread_mutex_t</span><span class=\"mtk1\"> mutex </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> PTHREAD_MUTEX_INITIALIZER;</span><span class=\"mtk3\"> // (1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> shared </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span><span class=\"mtk3\"> // shared variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk6\">foo</span><span class=\"mtk1\">(){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">pthread_mutex_lock</span><span class=\"mtk1\">(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk1\">mutex);</span><span class=\"mtk3\"> // (2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // critical section</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10000</span><span class=\"mtk1\">; </span><span class=\"mtk7\">++</span><span class=\"mtk1\">i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        shared </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">pthread_mutex_unlock</span><span class=\"mtk1\">(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk1\">mutex);</span><span class=\"mtk3\"> // (3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> </span><span class=\"mtk6\">main</span><span class=\"mtk1\">(){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // create threads</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15 mtki\">pthread_t</span><span class=\"mtk1\"> threads[NUM_THREADS];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // create threads[i] that executes foo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> NUM_THREADS; </span><span class=\"mtk7\">++</span><span class=\"mtk1\">i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">pthread_create</span><span class=\"mtk1\">(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk1\">threads[i], </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">, foo, </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // execute threads[i] for all i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> NUM_THREADS; </span><span class=\"mtk7\">++</span><span class=\"mtk1\">i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">pthread_join</span><span class=\"mtk1\">(threads[i], </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">printf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&quot;final result is </span><span class=\"mtk4\">%d\\n</span><span class=\"mtk11\">&quot;</span><span class=\"mtk1\">, shared);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>(1) : 변수 mutex를 뮤텍스 락 PTHREAD_MUTEX_INITIALIZER으로 초기화한다.</li>\n<li>(2) : pthread_mutex_lock(&#x26;mutex)은 mutex를 잠근다. 즉, 명시되어 있지 않지만 전역 변수 lock의 값을 true로 변경한다.</li>\n<li>(3) : pthread_mutex_unlock(&#x26;mutex)은 mutex를 잠근다. 즉, 전역 변수 lock의 값을 false로 변경한다.</li>\n<li>위 스크립트는 여러번 실행해도 40000을 출력한다.</li>\n<li>만약 (2)와 (3)을 생략하면 동기화가 되지 않아 실행할 때 마다 다른 값을 출력하게 된다.</li>\n</ul>\n<h4>Python 으로 구현하기</h4>\n<p>같은 작업을 python으로 구현해보자.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"python\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> threading </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> Thread, Lock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">num </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">def</span><span class=\"mtk1\"> </span><span class=\"mtk6\">foo</span><span class=\"mtk1\">(</span><span class=\"mtk19 mtki\">lock</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lock.acquire() </span><span class=\"mtk3\"># (1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># critical section</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> _ </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> </span><span class=\"mtk15\">range</span><span class=\"mtk1\">(</span><span class=\"mtk4\">100000</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">global</span><span class=\"mtk1\"> num</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        num </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lock.release() </span><span class=\"mtk3\"># (2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> __name__ </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&#39;__main__&#39;</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># initiate Mutex lock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    lock </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Lock()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># create two threads that execute foo,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># synchronized with mutex lock</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Thread(</span><span class=\"mtk19 mtki\">target</span><span class=\"mtk7\">=</span><span class=\"mtk1\">foo, </span><span class=\"mtk19 mtki\">args</span><span class=\"mtk7\">=</span><span class=\"mtk1\">(lock,))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Thread(</span><span class=\"mtk19 mtki\">target</span><span class=\"mtk7\">=</span><span class=\"mtk1\">foo, </span><span class=\"mtk19 mtki\">args</span><span class=\"mtk7\">=</span><span class=\"mtk1\">(lock,))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># execute threads</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t1.start()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t2.start()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">print</span><span class=\"mtk1\">(num)</span></span></span></code></pre>\n<ul>\n<li>(1) : 뮤텍스 락 lock 을 잠그어 다른 스레드가 전역 변수 num에 접근하지 못하게 한다.</li>\n<li>(2) : 뮤텍스 락 lock 을 해제한다.</li>\n</ul>\n<br>\n<h3>2.2. 세마포어</h3>\n<p><strong>세마포어(Semaphore)</strong> 는 뮤텍스 락과 비슷하게 구현하지만, 보다 일반적으로 복수의 공유 자원을 관리하는 동기화 방법이다.</p>\n<p>다음 세가지 항목으로 구현할 수 있다.</p>\n<ul>\n<li>전역 변수 S : 임계 구역에 진입 가능한 프로세스의 개수 또는 사용 가능한 공유 자원의 개수</li>\n<li>함수 wait (P) : 임계 구역에 진입 가능하면 진입해 S를 1 감소하고, 임계 구역에 진입이 불가능하면 대기한다.</li>\n<li>함수 signal (V) : 임계 구역에서 작업을 마친 후 S를 1 증가시킨다.</li>\n</ul>\n<p>세마포어로 상호 배제를 위한 동기화를 구현하는 과정은 다음과 같다.</p>\n<ol>\n<li>전역 변수 S에 사용 가능한 공유 자원의 개수를 할당한다.</li>\n<li>임계 구역의 앞에 wait을, 임계 구역의 뒤에 signal를 호출한다.</li>\n</ol>\n<p>세마포어는 실행 순서 제어를 위한 동기화도 구현할 수 있다.</p>\n<ol>\n<li>전역 변수 S를 0으로 초기화한다.</li>\n<li>먼저 실행할 프로세스 또는 스레드 뒤에 wait 함수로 접근을 제한한다.</li>\n<li>그 다음 실행할 프로세스 또는 스레드 뒤에 signal로 접근 제한을 해제한다.</li>\n</ol>\n<h4>Wait Queue</h4>\n<p>함수 wait에서 임계 구역에 진입할 수 있을 때까지 반복적으로 진입 가능 여부를 확인하는 것을 방지하기 위해 대기 큐(Wait Queue)를 사용할 수 있다.</p>\n<ul>\n<li>wait 함수는 사용할 수 있는 자원이 없을 경우 프로세스를 대기 상태로 만들고 PCB를 세마포를 위한 대기 큐에 넣는다.</li>\n<li>다른 프로세스가 임계 구역에서 작업이 끝나 signal 함수를 호출하면 대기 큐의 상단에 있는 프로세스를 제거하고, 준비 상태로 변경해서 준비 큐로 옮긴다.</li>\n</ul>\n<p>각 함수의 pseudo code는 다음과 같다.</p>\n<pre class=\"grvsc-container abyss\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">// wait</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">wait(){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    S --;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (S &lt; 0){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        add process P to Waiting Queue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        sleep();</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">//signal</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">signal(p){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    S ++;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    if (S &lt;= 0){</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        remove process P from Queue;</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">        wakeup(P);</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">}</span></span></code></pre>\n<h4>C++ 로 구현하기</h4>\n<pre class=\"grvsc-container abyss\" data-language=\"cpp\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// from https://en.cppreference.com/w/cpp/thread/counting_semaphore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;stdio.h&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;pthread.h&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#include</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&lt;semaphore.h&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">#define</span><span class=\"mtk1\"> </span><span class=\"mtk6\">NUM_THREADS</span><span class=\"mtk1\"> </span><span class=\"mtk4\">4</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5 mtku\">std</span><span class=\"mtk1\">::</span><span class=\"mtk5 mtku\">counting_semaphore</span><span class=\"mtk1\">&lt;</span><span class=\"mtk4\">1</span><span class=\"mtk1\">&gt; </span><span class=\"mtk6\">semaphore</span><span class=\"mtk1\">(</span><span class=\"mtk4\">1</span><span class=\"mtk1\">);</span><span class=\"mtk3\"> // (1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> shared </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span><span class=\"mtk3\"> // shared variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk7\">*</span><span class=\"mtk6\">foo</span><span class=\"mtk1\">(){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    semaphore.</span><span class=\"mtk6\">acquire</span><span class=\"mtk1\">();</span><span class=\"mtk3\"> // (2) wait</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // critical section</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10000</span><span class=\"mtk1\">; </span><span class=\"mtk7\">++</span><span class=\"mtk1\">i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        shared </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    semaphore.</span><span class=\"mtk6\">release</span><span class=\"mtk1\">();</span><span class=\"mtk3\"> // (3) signal</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> </span><span class=\"mtk6\">main</span><span class=\"mtk1\">(){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // initiate threads</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15 mtki\">pthread_t</span><span class=\"mtk1\"> threads[NUM_THREADS];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // create threads[i] that executes foo</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> NUM_THREADS; </span><span class=\"mtk7\">++</span><span class=\"mtk1\">i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">pthread_create</span><span class=\"mtk1\">(</span><span class=\"mtk7\">&amp;</span><span class=\"mtk1\">threads[i], </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">, foo, </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">    // execute threads[i] for all i</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk15 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> NUM_THREADS; </span><span class=\"mtk7\">++</span><span class=\"mtk1\">i) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk6\">pthread_join</span><span class=\"mtk1\">(threads[i], </span><span class=\"mtk4\">NULL</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk6\">printf</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&quot;final result is </span><span class=\"mtk4\">%d\\n</span><span class=\"mtk11\">&quot;</span><span class=\"mtk1\">, shared);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>(1) : 세마포 객체 semaphore를 1 개의 공유 자원을 가지는 세마포로 초기화한다.</li>\n<li>(2) : semaphore에 wait(acquire) 함수를 구현해 사용 가능한 자원 수(S)를 1 감소시킨다.</li>\n<li>(3) : semaphore에 signal(release) 함수를 구현해 사용 가능한 자원 수(S)를 1 증가시킨다.</li>\n<li>전역 변수 num의 값을 1씩 100000번 증가시키는 스레드 두개를 동기화해서 실행했으므로, 출력 값은 200000이다.</li>\n</ul>\n<h4>Python 으로 구현하기</h4>\n<p>세마포어와 뮤텍스 락의 구현은 유사하지만, 다음과 같은 차이점을 가진다.</p>\n<ul>\n<li>Lock이 Semaphore로 변경되었다.</li>\n<li>Semaphore 객체는 인자로 공유 자원의 개수를 입력받으며 초기값은 1이다.</li>\n<li>인자로 전달된 값이 0 보다 작으면 ValueError가 발생한다.</li>\n<li>release 메서드는 인자로 해제할 자원의 개수를 받을 수 있다.</li>\n</ul>\n<pre class=\"grvsc-container abyss\" data-language=\"python\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">//</span><span class=\"mtk1\"> code </span><span class=\"mtk7\">from</span><span class=\"mtk1\"> https:</span><span class=\"mtk7\">//</span><span class=\"mtk1\">github.com</span><span class=\"mtk7\">/</span><span class=\"mtk1\">kangtegong</span><span class=\"mtk7\">/</span><span class=\"mtk1\">self</span><span class=\"mtk7\">-</span><span class=\"mtk1\">learning</span><span class=\"mtk7\">-</span><span class=\"mtk1\">cs</span><span class=\"mtk7\">/</span><span class=\"mtk1\">blob</span><span class=\"mtk7\">/</span><span class=\"mtk1\">main</span><span class=\"mtk7\">/</span><span class=\"mtk1\">synchronization</span><span class=\"mtk7\">/</span><span class=\"mtk1\">syncronization.md</span><span class=\"mtk3\">#%EC%BD%94%EB%93%9C%EB%A1%9C-%EB%B3%B4%EB%8A%94-%EB%8F%99%EA%B8%B0%ED%99%94</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">from</span><span class=\"mtk1\"> threading </span><span class=\"mtk7\">import</span><span class=\"mtk1\"> Thread, Semaphore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">num </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\"># Critical section</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15 mtki\">def</span><span class=\"mtk1\"> </span><span class=\"mtk6\">foo</span><span class=\"mtk1\">(</span><span class=\"mtk19 mtki\">sem</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    sem.acquire() </span><span class=\"mtk3\"># (2)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> _ </span><span class=\"mtk7\">in</span><span class=\"mtk1\"> </span><span class=\"mtk15\">range</span><span class=\"mtk1\">(</span><span class=\"mtk4\">100000</span><span class=\"mtk1\">):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">global</span><span class=\"mtk1\"> num</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        num </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    sem.release() </span><span class=\"mtk3\"># (3)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">if</span><span class=\"mtk1\"> __name__ </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> </span><span class=\"mtk11\">&#39;__main__&#39;</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># initiate semaphore object</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    sem </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Semaphore(</span><span class=\"mtk4\">1</span><span class=\"mtk1\">) </span><span class=\"mtk3\"># (1)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># create two threads that execute foo,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># synchronized with semaphore</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t1 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Thread(</span><span class=\"mtk19 mtki\">target</span><span class=\"mtk7\">=</span><span class=\"mtk1\">foo, </span><span class=\"mtk19 mtki\">args</span><span class=\"mtk7\">=</span><span class=\"mtk1\">(sem,))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t2 </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> Thread(</span><span class=\"mtk19 mtki\">target</span><span class=\"mtk7\">=</span><span class=\"mtk1\">foo, </span><span class=\"mtk19 mtki\">args</span><span class=\"mtk7\">=</span><span class=\"mtk1\">(sem,))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\"># execute threads</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t1.start()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    t2.start()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">print</span><span class=\"mtk1\">(num)</span></span></span></code></pre>\n<br>\n<h3>2.3. 모니터</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 914px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkElEQVR42m2T6QrCQAyE+/7P5R8pIt5Htd4HKkI9Wu/IN5BSpQtx124ymWSygZnZ5/OxstXpdGw6ndp8Ptder9etVqtp73a7+o5NJhPr9XqKCRzs9XrZ9Xq1+/1uWZbZ4/GwxWLxk+BwOFgcxwLhXFyr1cre77cF/DjLZrOpzI1Gw7bbrS2XSzlhZVX4HWRILkAubrebaM9mMxuNRiqP83A4/AnG7/l8ij3nYhJYCxCg3W4nRpRLADtBMHQAb8PxeLTz+awzO4k9HqZBFEW23+/153K5qI8EeykEpWkqRpxhPRgM5Hc6nSQGpIghXiVzsV6vVYL3C/NGs2AKMAYYRsKiKPgIEPRqtapMLhBGL/0/DB286OMkEIVzDlipVPIxcfXoj4tGQvoGC5iVAeYqUwYj8z93KOdrPB6rTJpPr/7XD2CSJNbv9+XIBcywVquVvxKqQE1EAXSz2ciYBHy9XTkg4+AvhrEpG2K+ozDKAsyEUB3fXaAcMAxDa7fber/sBMHaDSDeMCAoCmsYFheifAHiP+A+wneozwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cs monitor java\"\n        title=\"\"\n        src=\"/static/2635c63e28b0483af129f053b31fca4d/076ca/cs-monitor_java.png\"\n        srcset=\"/static/2635c63e28b0483af129f053b31fca4d/5a46d/cs-monitor_java.png 300w,\n/static/2635c63e28b0483af129f053b31fca4d/0a47e/cs-monitor_java.png 600w,\n/static/2635c63e28b0483af129f053b31fca4d/076ca/cs-monitor_java.png 914w\"\n        sizes=\"(max-width: 914px) 100vw, 914px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span>\nMonitor in Java, from <a href=\"https://upload.wikimedia.org/wikipedia/commons/f/f5/Monitor_%28synchronization%29-Java.png\">wikimedia</a></p>\n<p>모니터(Monitor)는 공유 자원과 공유 자원에 접근하는 인터페이스를 묶어서 관리하는 동기화 방식이다.</p>\n<ul>\n<li>모니터는 한 번에 하나의 프로세스 또는 스레드만 진입하도록 하는 방법으로 상호 배제를 실현한다.</li>\n<li>모니터 방식에서 프로세스 또는 스레드는 모니터 인터페이스(프로시저)를 통해서만 공유 자원에 접근할 수 있다.</li>\n<li>모니터 외부에는 준비 큐가 있어 모니터에 진입하고자 하는-즉 공유 자원에 접근하고자 하는 프로세스 또는 스레드가 적재되어 대기한다.</li>\n</ul>\n<p>조건 변수(Conditional Variable)는 실행 순서 제어를 위해 사용되는 개념이다.</p>\n<ul>\n<li>모니터 내부에 들어가 공유 자원에 접근한 프로세스 또는 스레드가 실행 도중에 특정 변수로 인해 실행 조건을 충족하지 못하면, 원인이 되는 변수를 조건 변수라고 한다.</li>\n<li>조건 변수마다 준비 큐가 있어 실행되지 못한 프로세스나 스레드를 저장한다.</li>\n<li>모니터에서 실행되지 못한 프로세스나 스레드는 조건 변수 <code>x</code>에 대해 <code>x.wait()</code>을 호출해서 <code>x</code>에 대한 준비 큐에 삽입되고 모니터는 빈 상태가 된다.</li>\n<li>다른 프로세스나 스레드가 모니터에 들어와서 작업을 수행하고 조건 변수 x의 준비 큐에 저장된 프로세스 또는 스레드의 실행 조건을 만족시키면, <code>x.signal()</code>이 호출되어 준비 큐의 프로세스 또는 스레드가 큐에서 모니터로 이동해 실행된다.</li>\n</ul>\n<br>\n<h3>참고자료</h3>\n<ul>\n<li>『혼자 공부하는 컴퓨터 구조 + 운영체제』, 강민철, 한빛미디어</li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .abyss { background-color: #000c18; }\n  .abyss .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .abyss .mtki { font-style: italic; }\n  .abyss .mtk3 { color: #384887; }\n  .abyss .mtk15 { color: #9966B8; }\n  .abyss .mtk1 { color: #6688CC; }\n  .abyss .mtk6 { color: #DDBB88; }\n  .abyss .mtk7 { color: #225588; }\n  .abyss .mtk4 { color: #F280D0; }\n  .abyss .mtk11 { color: #22AA44; }\n  .abyss .mtk5 { color: #FFEEBB; }\n  .abyss .mtk19 { color: #2277FF; }\n  .abyss .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"[OS] 동기화 : 뮤텍스 락, 세마포, 모니터","date":"September 07, 2022"}}},"pageContext":{"slug":"/CS/OS/2022-09-07-cs-synchronization/","previous":{"fields":{"slug":"/CS/OS/2022-09-06-cs-virtual-memory-2/"},"frontmatter":{"title":"[OS] 페이지 대체와 프레임 할당"}},"next":{"fields":{"slug":"/CS/OS/2022-09-10-cs-file-system/"},"frontmatter":{"title":"[OS] 파일 시스템"}}}},"staticQueryHashes":["1185972000","3231742164"],"slicesMap":{}}